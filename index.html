<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <title>Game Ratings</title>
        <meta charset="utf-8" />
        <title>Homepage</title>
        <link href="PageStyling.css" rel="stylesheet" type="text/css">
        <script>
            function showMostPopular() {
                var xmlhttpMostPopular = new XMLHttpRequest();
                var mostPopular = "";

                xmlhttpMostPopular.onreadystatechange = function() {
                    if(this.readyState == 4 && this.status == 200) {
                        mostPopular += this.responseText;

                        document.getElementById("MostPopularAccordion").innerHTML = mostPopular;
                    }
                }
                xmlhttpMostPopular.open("GET", "MostPopular.php", true);
                xmlhttpMostPopular.send();
            }

            function getTotalNumGames() {
                var xmlhttpTotalNumGames = new XMLHttpRequest();
                var numTotalGames = 0;
                
                xmlhttpTotalNumGames.onreadystatechange = function() {
                    if(this.readyState == 4 && this.status == 200)  {
                        numTotalGames = Number(this.responseText);

                        getFeaturedGame(numTotalGames);
                    }
                }
                xmlhttpTotalNumGames.open("GET", "GetTotalGames.php", true);
                xmlhttpTotalNumGames.send();
            }

            function getFeaturedGame(numTotalGames) {
                var xmlhttpFeaturedGame = new XMLHttpRequest();

                //Get featured gameID based on the current date
                const oneDay = 24 * 60 * 60 * 1000;     //get one day in milliseconds
                const firstDate = new Date(1900,1,1);   //get a starting date to start counting days from
                const secondDate = new Date();          //get current date
                //get the difference between dates in number of days and get the modular of result using total number of games in the database to obtain gameID
                var gameID = Math.floor((secondDate - firstDate) / oneDay) % numTotalGames;
                    
                xmlhttpFeaturedGame.onreadystatechange = function() {
                    if(this.readyState == 4 && this.status == 200) {
                        //featuredGameData += this.responseText;
                        const gameData = JSON.parse(this.responseText);

                        document.getElementById("FeaturedGameBoxArt").innerHTML = "<img src=\"" + gameData['BoxArt'] + "\" class=\"img-fluid d-block m-auto\">";
                        document.getElementById("FeaturedGameGameName").innerHTML = gameData["Game Name"];
                        document.getElementById("FeaturedGameDescription").innerHTML = gameData['Description'];
                        document.getElementById("FeaturedGameDeveloper").innerHTML = gameData['Developer Name'];
                        document.getElementById("FeaturedGamePublisher").innerHTML = gameData['Publisher Name'];
                        document.getElementById("FeaturedGameGenre").innerHTML = gameData['Genre'];

                        //parse release date im desired format (YYYY-MM-DD)
                        var parseReleaseDate = JSON.parse(JSON.stringify(gameData["Release Date NA"]));
                        var releaseDate = JSON.stringify(parseReleaseDate["date"]).split(" ");
                        releaseDate = releaseDate[0].split("\"");
                        document.getElementById("FeaturedGameReleaseDate").innerHTML = releaseDate[1];

                        //Get the platform data for the featured game
                        getPlatformData(gameID);

                        document.getElementById("FeaturedGameScore").innerHTML = gameData['CurrentScore'];
                    }               
                }
                xmlhttpFeaturedGame.open("GET", "TestGameData.php?q=" + gameID, true);
                xmlhttpFeaturedGame.send();
            }

            function getPlatformData(gameID) {
                var xmlhttpPlatforms = new XMLHttpRequest();

                xmlhttpPlatforms.onreadystatechange = function() {
                    if(this.readyState == 4 && this.status == 200) {
                        document.getElementById("FeaturedGamePlatforms").innerHTML = this.responseText;
                    }
                };
                xmlhttpPlatforms.open("GET", "PlatformsData.php?q=" + gameID, false);
                xmlhttpPlatforms.send();
            }

            function mostRecentReleases() {
                var xmlhttpMostRecentReleases = new XMLHttpRequest();
                var mostRecentReleasesTable = "<h5 style=\"width: 250; background-color: #C0C0C0; color: #303030; margin-bottom: 2px\">&nbspMost Recent Releases</h5><table style=\"width: 100%;\"; rules=\"none\"><colgroup><col span=\"1\" style=\"width: 5%\"><col span=\"1\" style=\"width: 75%\"><col span=\"1\" style=\"width: 20%\"></colgroup>";
                    
                xmlhttpMostRecentReleases.onreadystatechange = function() {
                    if(this.readyState == 4 && this.status == 200) {
                        mostRecentReleasesTable += this.responseText;
                        mostRecentReleasesTable += "</table>";

                        document.getElementById("MostRecentReleases").innerHTML = mostRecentReleasesTable;
                    }               
                }
                xmlhttpMostRecentReleases.open("GET", "MostRecentReleases.php", true);
                xmlhttpMostRecentReleases.send();
            }
        </script>
    </head>

    <!-- load in JavaScript functions -->
    <body onLoad="showMostPopular(); mostRecentReleases(); getTotalNumGames()">
        <!-- Navbar with Site Icon, Title and Search bar -->
        <!-- Create navbar that shows search bar and button on medium screens or larger and stays fixed to the top when scrolling -->
        <nav class="navbar navbar-expand-md top navbar-dark bg-dark p-1">
            <div class="container-xxl"> <!-- use xxl container to keep icon/title and search bar/button no further than a certain distance from each other in case viewed on extremely large screens  -->
                <!-- set the icon for the website and the title (current doesn't link to anything, but will be homepage button)-->
                <a href="#" class="navbar-brand">
                    <span class="fw-bold text-white h1">
                        <i class="bi bi-joystick"></i>
                        Game Ratings
                    </span>
                </a>

                <!-- nav button that appears on smaller screens such as mobile/phone screens -->
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSearchField">
                    <i class="bi bi-search"></i> <!-- collapsed navbar icon -->
                </button>

                <!-- Search bar and submit button for searching games on site. Enclosed in div that hides the search bar and button behind the above navbar toggler button on smaller screen sizes -->
                <div class="collapse navbar-collapse justify-content-end" id="navbarSearchField">
                    <form  action="search.html" class="d-flex pt-3" role="search">
                        <input type="search" id="Game" name="Game" class="form-control me-2" placeholder="Search...">

                        <!-- hidden search fields to feed search filters once search button is clicked -->
                        <input type="hidden" id="Dev" name="Developer">
                        <input type="hidden" id="Pub" name="Publisher">
                        <input type="hidden" id="Platform" name="Platform">
                        <input type="hidden" id="Year" name="Year">

                        <!-- search button -->
                        <button class="btn btn-outline-light fw-bold" type="submit">Search</button>
                    </form>
                </div>
            </div>
        </nav>

        <!-- Accordion dropdown for Most Popular feature -->
        <section class="py-5" id="MostPopular">
            <div class="container-md">
                
                <!-- Display title of section on page -->
                <div class="row justify-content-center">
                    <div class="">
                        <h2 class="fw-bold px-3">Most Popular</h2>
                        <hr class="bg-dark"> <!-- override height and colour once I get to doing the custom theme -->
                    </div>
                </div>

                <!-- Setup and get contents of the accordion object for displaying top 10 most popular games -->
                <div class="row justify-content-center">
                    <div class="">
                        <div class="accordion" id="games">
                            <span id="MostPopularAccordion"></span>
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- Featured Game Section -->
        <section class="bg-dark py-5 text-white" id="FeaturedGame">
            <div class="container-md">

                <!-- Display title of section on page -->
                <div class="row justify-content-center">
                    <div class="">
                        <h2 class="fw-bold px-3">Featured Game</h2>
                        <hr class="bg-light"> <!-- override height and colour once I get to doing the custom theme -->
                    </div>
                </div>

                <!-- Get and display featured game info -->
                <div class="row justify-content-center">
                    <div class="col-lg-3 mb-2">
                        <span id="FeaturedGameBoxArt"></span>
                    </div>
                    <div class="col-lg-9 px-2">
                        <div class="row">
                            <h2><span id="FeaturedGameGameName"></span></h2>
                        </div>
                        <div class="row">
                            <p><span id="FeaturedGameDescription"></span></p>
                            
                        </div>
                        <div class="row justify-content-between">
                            <div class="col-6 Justify-content-start">
                                <tag class="fw-bold">Developer: </tag><span id="FeaturedGameDeveloper"></span><br>
                                <tag class="fw-bold">Publisher: </tag><span id="FeaturedGamePublisher"></span><br>
                                <tag class="fw-bold">Genre: </tag><span id="FeaturedGameGenre"></span><br>
                                <tag class="fw-bold">Platform: </tag><span id="FeaturedGamePlatforms"></span><br>
                                <tag class="fw-bold">Release Date: </tag><span id="FeaturedGameReleaseDate"></span>
                            </div>
                            <div class="col-6 d-flex justify-content-center align-items-center">
                                <h1 class="fw-bold" style="transform: scale(2.0,2.0)"><span id="FeaturedGameScore"></span>0%</h1>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </section>
        
        <div style="width: 800px; margin: auto;">
            <div style="display: table;">
                <div style="display: table-row;">

                    <div style="width: 250px;  height: 20px; display: table-cell">
                        <span id="MostRecentReleases"></span>
                    </div>

                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    </body>
</html>